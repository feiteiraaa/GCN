Listagem As screen:
    OnVisible: |-
        =ClearCollect(
            Estados,
            Blank(),
            Choices('Estado Processo')
        );
        
        UpdateContext({
            checkBox: false,
            modalExport: false
        });
        
        ClearCollect(
            AtividadeFormMenu,
            Table(
            //Excel 02
                {
                    titulo: "Caracterização do Processo",
                    estado: "em curso",
                    modo: DisplayMode.Edit
                },
                {
                    titulo: "Fatores de Criticidade",
                    estado: "em falta",
                    modo: DisplayMode.Edit
                },
            //Excel 03
                {
                    titulo: "Caracterização dos Recursos",
                    estado: "em falta",
                    modo: DisplayMode.Disabled
                },
            //Excel 04
                {
                    titulo: "Caracterização dos Equipamentos",
                    estado: "em falta",
                    modo: DisplayMode.Disabled
                },
            //Excel 05
                {
                    titulo: "Caracterização dos Sistemas",
                    estado: "em falta",
                    modo: DisplayMode.Disabled
                },
            //Excel 06
                {
                    titulo: "Dependências",
                    estado: "em falta",
                    modo: DisplayMode.Disabled
                }
            )
        )

    "'Gallery Data' As gallery.variableTemplateHeightGallery":
        DelayItemLoading: =true
        Fill: =Color.White
        Height: =493
        Items: |-
            =With(
                {
                    records:
                    Filter(
                        Atividades,
                        (
                            TextInput2.Text in ThisRecord.Atividade Or
                            TextInput2.Text in ThisRecord.'Tipo de Processo'.'Tipo de Processo' Or
                            TextInput2.Text in ThisRecord.Processo.'Processo (uipp_processo)' Or
                            TextInput2.Text in ThisRecord.'Macro Processo'.'Macro Processo (uipp_macroprocesso)' Or
                            TextInput2.Text in ThisRecord.'Data de Decisão'
                        )
                        And
                        If(
                            !IsBlank(Dropdown1.SelectedText.Value),
                            Dropdown1.SelectedText.Value = Text(ThisRecord.Estado),
                            true
                        )
                    )
                },
                ForAll(
                    Sequence(CountRows(records)),
                    Patch(
                        Last(
                            FirstN(
                                SortByColumns(
                                    records,
                                    "createdon",
                                    SortOrder.Descending
                                ),
                                Value
                            )
                        ),
                        {rowNumber: Value}
                    )
                )
            )
        Layout: =Layout.Vertical
        LoadingSpinner: =LoadingSpinner.Data
        OnSelect: =
        ShowScrollbar: =false
        TemplateFill: |-
            =If(
                Mod(ThisItem.rowNumber, 2) = 0,
                Color.LightSlateGray,
                Color.White
            )
        TemplatePadding: =0
        TemplateSize: =75
        Width: =Principal.Width
        X: =Principal.X
        Y: =Principal.Y + Principal.Height
        ZIndex: =13

        Rectangle2 As rectangle:
            Fill: |-
                =Switch(
                    Trim(Lower(ThisItem.Estado)),
                    
                    Trim(Lower("Em preenchimento")),
                    Color.Blue,
                    
                    Trim(Lower("Em validação")),
                    Color.Yellow,
                
                    Trim(Lower("Aprovado")),
                    Color.Green,
                
                    Trim(Lower("Rejeitado")),
                    Color.Red,
                
                    Trim(Lower("Em revisão pela U.O.")),
                    Color.DarkOrange,
                
                    Trim(Lower("Em revalidação")),
                    Color.Yellow
                
                )
            Height: =75
            OnSelect: =Select(Parent)
            Width: =7
            ZIndex: =1

        "'U.O.' As label":
            Align: =Align.Center
            Color: |-
                =If(
                    Mod(ThisItem.rowNumber, 2) = 0,
                    Color.White,
                    Color.DarkSlateGray
                )
            Height: =Rectangle2.Height
            OnSelect: |-
                =Select(Parent);
                Navigate('Atividade Form Screen',ScreenTransition.None, {formMode: FormMode.View, Criticidade: 0});
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Text: =ThisItem.'Unidade Orgânica'
            Width: |-
                =If(
                    currentUser = "DRI",
                    118,
                    155
                )
            X: |-
                =If(
                    currentUser = "DRI",
                    45,
                    8
                )
            Y: =Rectangle2.Y
            ZIndex: =2

        "'U.O. Split' As rectangle":
            Fill: =Color.LightGray
            Height: =Rectangle2.Height
            OnSelect: =
            Width: =2
            X: ='U.O.'.X + 'U.O.'.Width
            Y: =Rectangle2.Y
            ZIndex: =3

        Atividade As label:
            Align: =Align.Center
            Color: |-
                =If(
                    Mod(ThisItem.rowNumber, 2) = 0,
                    Color.White,
                    Color.DarkSlateGray
                )
            Height: =Rectangle2.Height
            OnSelect: |-
                =Select(Parent);
                Navigate('Atividade Form Screen',ScreenTransition.None, {formMode: FormMode.View, Criticidade: 0});
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Text: =ThisItem.Atividade
            Width: |-
                =(
                    Principal.Width - ('U.O. Header Split'.Width * 6)
                ) / 6
            X: ='U.O. Split'.X + 'U.O. Split'.Width
            Y: =Rectangle2.Y
            ZIndex: =4

        "'Atividade Split' As rectangle":
            Fill: =Color.LightGray
            Height: =Rectangle2.Height
            OnSelect: =Atividade.X + Atividade.Width
            Width: =2
            X: =Atividade.X + Atividade.Width
            Y: =Rectangle2.Y
            ZIndex: =5

        Descricao As label:
            Align: =Align.Center
            Color: |-
                =If(
                    Mod(ThisItem.rowNumber, 2) = 0,
                    Color.White,
                    Color.DarkSlateGray
                )
            Height: =Rectangle2.Height
            OnSelect: |-
                =Select(Parent);
                Navigate('Atividade Form Screen',ScreenTransition.None, {formMode: FormMode.View, Criticidade: 0});
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Text: =ThisItem.'Descrição de atividade'
            Width: |-
                =(
                    Principal.Width - ('U.O. Header Split'.Width * 6)
                ) / 6
            X: ='Atividade Split'.X + 'Atividade Split'.Width
            Y: =Rectangle2.Y
            ZIndex: =6

        "'Descricao Split' As rectangle":
            Fill: =Color.LightGray
            Height: =Rectangle2.Height
            OnSelect: =
            Width: =2
            X: =Descricao.X + Descricao.Width
            Y: =Rectangle2.Y
            ZIndex: =7

        "'Tipo Processo' As label":
            Align: =Align.Center
            Color: |-
                =If(
                    Mod(ThisItem.rowNumber, 2) = 0,
                    Color.White,
                    Color.DarkSlateGray
                )
            Height: =Rectangle2.Height
            OnSelect: |-
                =Select(Parent);
                Navigate('Atividade Form Screen',ScreenTransition.None, {formMode: FormMode.View, Criticidade: 0});
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Text: =ThisItem.'Tipo de Processo'.'Tipo de Processo'
            Width: |-
                =(
                    Principal.Width - ('U.O. Header Split'.Width * 6)
                ) / 6
            X: ='Descricao Split'.X + 'Descricao Split'.Width
            Y: =Rectangle2.Y
            ZIndex: =8

        "'Tipo Processo Split' As rectangle":
            Fill: =Color.LightGray
            Height: =Rectangle2.Height
            OnSelect: =
            Width: =2
            X: ='Tipo Processo'.X + 'Tipo Processo'.Width
            Y: =Rectangle2.Y
            ZIndex: =9

        Processo As label:
            Align: =Align.Center
            Color: |-
                =If(
                    Mod(ThisItem.rowNumber, 2) = 0,
                    Color.White,
                    Color.DarkSlateGray
                )
            Height: =Rectangle2.Height
            OnSelect: |-
                =Select(Parent);
                Navigate('Atividade Form Screen',ScreenTransition.None, {formMode: FormMode.View, Criticidade: 0});
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Text: =ThisItem.Processo.'Processo (uipp_processo)'
            Width: |-
                =(
                    Principal.Width - ('U.O. Header Split'.Width * 6)
                ) / 6
            X: ='Tipo Processo Split'.X + 'Tipo Processo Split'.Width
            Y: =Rectangle2.Y
            ZIndex: =10

        "'Processo Split' As rectangle":
            Fill: =Color.LightGray
            Height: =Rectangle2.Height
            OnSelect: =
            Width: =2
            X: =Processo.X + Processo.Width
            Y: =Rectangle2.Y
            ZIndex: =11

        "'Macro Processo' As label":
            Align: =Align.Center
            Color: |-
                =If(
                    Mod(ThisItem.rowNumber, 2) = 0,
                    Color.White,
                    Color.DarkSlateGray
                )
            Height: =Rectangle2.Height
            OnSelect: |-
                =Select(Parent);
                Navigate('Atividade Form Screen',ScreenTransition.None, {formMode: FormMode.View, Criticidade: 0});
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Text: =ThisItem.'Tipo de Processo'.'Tipo de Processo'
            Width: |-
                =(
                    Principal.Width - ('U.O. Header Split'.Width * 6)
                ) / 6
            X: ='Processo Split'.X + 'Processo Split'.Width
            Y: =Rectangle2.Y
            ZIndex: =12

        Checkbox1_1 As checkbox:
            BorderColor: =Color.Transparent
            CheckboxBorderColor: =cores.cinzento
            CheckmarkFill: =cores.amareloMontepio
            Color: =cores.amareloMontepio
            Default: =checkBox
            Height: =74
            HoverColor: =cores.amareloMontepio
            PressedColor: =cores.amareloMontepio
            Text: =""
            Visible: =currentUser = "DRI"
            Width: =40
            X: =5
            Y: =1
            ZIndex: =13

    ActionBar As group:
        Height: =5
        Width: =5
        X: =60
        Y: =60
        ZIndex: =23

        TextInput2 As text:
            BorderColor: =ColorFade(cores.cinzento, 80%)
            BorderThickness: =1
            Clear: =true
            Color: |-
                =//RGBA(0, 0, 0, 1)
                cores.cinzento
            Default: =
            Fill: =ColorFade(cores.cinzento, 90%)
            Height: =29
            HoverBorderColor: =RGBA(128, 128, 128, 1)
            HoverFill: =
            PaddingLeft: =40
            Tooltip: =
            Width: =264
            X: =358
            Y: =124
            ZIndex: =15

        "Icon1_1 As icon.'3DPrinting'":
            Color: |-
                =///RGBA(0, 18, 107, 1)
                cores.amareloMontepio
            Height: =18
            Icon: =Icon.Search
            OnSelect: =//Select(Parent)
            Width: =18
            X: =365
            Y: =131
            ZIndex: =16

        Dropdown1 As dropdown:
            AllowEmptySelection: =true
            BorderColor: =cores.cinzento
            ChevronBackground: =cores.amareloMontepio
            ChevronFill: =Color.White
            ChevronHoverBackground: =cores.amareloMontepio
            ChevronHoverFill: =
            Default: =Blank()
            Height: =TextInput2.Height
            HoverColor: =
            HoverFill: =cores.amareloMontepio
            Items: =Estados
            PressedFill: =
            Reset: =true
            SelectionFill: =cores.amareloMontepio
            Width: =264
            X: =656
            Y: =TextInput2.Y
            ZIndex: =19

    Label1_1 As label:
        Size: =15
        Text: ="Atividades"
        Width: =360
        X: =359
        Y: =35
        ZIndex: =24

    NovaAtividade As group:
        Height: =5
        Width: =5
        X: =40
        Y: =40
        ZIndex: =24

        DynamicBtn_1 As DynamicBtn:
            BtnText: ="Nova Atividade"
            BtnWidth: =200
            X: =1143
            Y: =35
            ZIndex: =14

        Button2 As button:
            BorderColor: =Color.Transparent
            Color: =Color.Transparent
            Fill: =Color.Transparent
            Height: =DynamicBtn_1.Height
            HoverColor: =Color.Transparent
            HoverFill: =Color.Transparent
            OnSelect: |-
                =Navigate('Atividade Form Screen',ScreenTransition.None, {formMode: FormMode.New, Criticidade: 0});
                
                Concurrent(
                    UpdateContext({ RTO: 0, RTOTempo: "" }),
                    ResetForm('Caracterizacao do Processo');
                    ClearCollect(collectRecursos, Blank());
                    ClearCollect(collectEquipamentos, Blank());
                    ClearCollect(collectDependencias, Blank());
                    ClearCollect(collectSistemas, Blank())
                );
                
                ClearCollect(
                    AtividadeFormMenu,
                    Table(
                    //Excel 02
                        {
                            titulo: "Caracterização do Processo",
                            estado: "em curso",
                            modo: DisplayMode.Edit
                        },
                        {
                            titulo: "Fatores de Criticidade",
                            estado: "em falta",
                            modo: DisplayMode.Edit
                        },
                    //Excel 03
                        {
                            titulo: "Caracterização dos Recursos",
                            estado: "em falta",
                            modo: DisplayMode.Disabled
                        },
                    //Excel 04
                        {
                            titulo: "Caracterização dos Equipamentos",
                            estado: "em falta",
                            modo: DisplayMode.Disabled
                        },
                    //Excel 05
                        {
                            titulo: "Caracterização dos Sistemas",
                            estado: "em falta",
                            modo: DisplayMode.Disabled
                        },
                    //Excel 06
                        {
                            titulo: "Dependências",
                            estado: "em falta",
                            modo: DisplayMode.Disabled
                        }
                    )
                )
            PressedColor: =Color.Transparent
            Text: =
            Width: =DynamicBtn_1.Width
            X: =DynamicBtn_1.X
            Y: =DynamicBtn_1.Y
            ZIndex: =20

    AnualApproval As group:
        Height: =5
        Width: =5
        X: =20
        Y: =20
        ZIndex: =24

        AnualApprovalBtn As DynamicBtn:
            BtnText: ="Revisão anual"
            BtnWidth: =200
            ButtonIcon: =Icon.AddLibrary
            Visible: |-
                =CountRows(
                    Filter('Gallery Data'.AllItems, ThisRecord.Checkbox1_1.Value = true)
                )
            X: =719
            Y: =35
            ZIndex: =18

        AnualApprovalBtnCode As button:
            BorderColor: =Color.Transparent
            Color: =Color.Transparent
            Fill: =Color.Transparent
            Height: =AnualApprovalBtn.Height
            HoverColor: =Color.Transparent
            HoverFill: =Color.Transparent
            OnSelect: |-
                =ForAll(
                    Filter('Gallery Data'.AllItems, ThisRecord.Checkbox1_1.Value) As Record,
                    
                    Patch(
                        Atividades,
                        LookUp( Atividades, ThisRecord.ID = Record.ID),
                        {
                            Estado: 'Estado Processo'.'Em revalidação'
                        }
                    );
                    Patch(
                        'Histórico de aprovações',
                        Defaults('Histórico de aprovações'),
                        {
                            Estado: 'Estado Processo'.'Em revalidação',
                            'ID Atividade': LookUp(Atividades, ThisRecord.ID = LastAtividadeId)
                        }
                    );
                
                    'GCN-Pediraprovação'.Run(
                        Record.ID,
                        Record.'Unidade Orgânica',
                        Record.Atividade
                    )
                )
            PressedColor: =Color.Transparent
            Text: =
            Visible: |-
                =CountRows(
                    Filter('Gallery Data'.AllItems, ThisRecord.Checkbox1_1.Value = true)
                )
            Width: =AnualApprovalBtn.Width
            X: =719
            Y: =AnualApprovalBtn.Y
            ZIndex: =21

    LeftSectionComponent_2 As LeftSectionComponent:
        ZIndex: =25

    "'Galery Headers' As group":
        Height: =5
        Width: =5
        X: =40
        Y: =40
        ZIndex: =25

        Principal As rectangle:
            Fill: =cores.cinzento
            Height: =63
            OnSelect: =
            TabIndex: =0
            Width: =990
            X: =358
            Y: =176
            ZIndex: =1

        "'U.O. Header' As label":
            Align: =Align.Center
            Color: =Color.LightGray
            Height: =Principal.Height
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            TabIndex: =0
            Text: ="Unidade Orgânica"
            Width: |-
                =If(
                    currentUser = "DRI",
                    124,
                    155
                )
            X: |-
                =If(
                    currentUser = "DRI",
                    397,
                    362
                )
            Y: =176
            ZIndex: =2

        "'U.O. Header Split' As rectangle":
            Fill: =Color.LightGray
            Height: =Principal.Height
            OnSelect: =
            TabIndex: =0
            Width: =2
            X: =521
            Y: =Principal.Y
            ZIndex: =3

        "'Atividade Header' As label":
            Align: =Align.Center
            Color: =Color.LightGray
            Height: =Principal.Height
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            TabIndex: =0
            Text: ="Atividade"
            Width: |-
                =(
                    Principal.Width - ('U.O. Header Split'.Width * 6)
                ) / 6
            X: =523
            Y: =176
            ZIndex: =4

        "'Atividade Header Split' As rectangle":
            Fill: =Color.LightGray
            Height: =Principal.Height
            OnSelect: =
            TabIndex: =0
            Width: =2
            X: =686
            Y: =Principal.Y
            ZIndex: =5

        "'Descricao Header' As label":
            Align: =Align.Center
            Color: =Color.LightGray
            Height: =Principal.Height
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            TabIndex: =0
            Text: ="Descrição"
            Width: |-
                =(
                    Principal.Width - ('U.O. Header Split'.Width * 6)
                ) / 6
            X: =688
            Y: =176
            ZIndex: =6

        "'Descricao Header Split' As rectangle":
            Fill: =Color.LightGray
            Height: =Principal.Height
            OnSelect: =
            TabIndex: =0
            Width: =2
            X: =851
            Y: =Principal.Y
            ZIndex: =7

        "'Tipo Processo Header' As label":
            Align: =Align.Center
            Color: =Color.LightGray
            Height: =Principal.Height
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            TabIndex: =0
            Text: ="Tipo de processo"
            Width: |-
                =(
                    Principal.Width - ('U.O. Header Split'.Width * 6)
                ) / 6
            X: =853
            Y: =176
            ZIndex: =8

        "'Tipo Processo Header Split' As rectangle":
            Fill: =Color.LightGray
            Height: =Principal.Height
            OnSelect: =
            TabIndex: =0
            Width: =2
            X: =1016
            Y: =Principal.Y
            ZIndex: =9

        "'Processo Header' As label":
            Align: =Align.Center
            Color: =Color.LightGray
            Height: =Principal.Height
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            TabIndex: =0
            Text: ="Processo"
            Width: |-
                =(
                    Principal.Width - ('U.O. Header Split'.Width * 6)
                ) / 6
            X: =1018
            Y: =176
            ZIndex: =10

        "'Processo Header Split' As rectangle":
            Fill: =Color.LightGray
            Height: =Principal.Height
            OnSelect: =
            TabIndex: =0
            Width: =2
            X: =1181
            Y: =Principal.Y
            ZIndex: =11

        "'Macro Processo Header Split' As label":
            Align: =Align.Center
            Color: =Color.LightGray
            Height: =Principal.Height
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            TabIndex: =0
            Text: ="Macro processo"
            Width: |-
                =(
                    Principal.Width - ('U.O. Header Split'.Width * 6)
                ) / 6
            X: =1183
            Y: =176
            ZIndex: =12

        Checkbox1 As checkbox:
            BorderColor: =Color.Transparent
            CheckboxBorderColor: =cores.cinzento
            CheckmarkFill: =cores.amareloMontepio
            Color: =cores.amareloMontepio
            HoverColor: =cores.amareloMontepio
            OnSelect: |-
                =UpdateContext({checkBox: !checkBox})
            PressedColor: =cores.amareloMontepio
            Text: =""
            Visible: =currentUser = "DRI"
            Width: =40
            X: =362
            Y: =182
            ZIndex: =17

    Export As group:
        Height: =5
        Width: =5
        X: =20
        Y: =20
        ZIndex: =26

        ExportBtn As DynamicBtn:
            BtnText: ="Exportar"
            BtnWidth: =200
            Visible: =If(currentUser = "DRI", true, false)
            X: =931
            Y: =35
            ZIndex: =22

        ExportBtnCode As button:
            BorderColor: =Color.Transparent
            Color: =Color.Transparent
            Fill: =Color.Transparent
            Height: =ExportBtn.Height
            HoverColor: =Color.Transparent
            HoverFill: =Color.Transparent
            OnSelect: |-
                =ClearCollect(
                    dataToExport,
                    ForAll(
                        'Gallery Data'.AllItems,
                        {
                            'ID Atividade': ThisRecord.ID,
                            Atividade: ThisRecord.Atividade,
                            'Descrição de atividade': ThisRecord.'Descrição de atividade',
                            'Tipo processo': ThisRecord.'Tipo de Processo'.'Tipo de Processo',
                            'Macro Processo': ThisRecord.'Macro Processo'.'Macro Processo (uipp_macroprocesso)',
                            Processo: ThisRecord.Processo.'Processo (uipp_processo)',
                            'Unidade Orgânica': ThisRecord.'Unidade Orgânica',
                            Estado: Text(ThisRecord.Estado),
                            Edifício: ThisRecord.Edifício.Localização,
                            Observações: ThisRecord.Observações,
                            'Data de Decisão': Text(ThisRecord.'Data de Decisão', DateTimeFormat.ShortDateTime24, "pt-PT"),
                            Comentários: ThisRecord.Comentários,
                            'Criado em': Text(ThisRecord.'Created On', DateTimeFormat.ShortDateTime24, "pt-PT"),
                            'Created By': ThisRecord.'Created By'.'Full Name'
                        }
                    )
                );
                
                Set(
                    dataExport,
                    JSON(
                        dataToExport,
                        JSONFormat.IgnoreUnsupportedTypes
                        &
                        JSONFormat.IgnoreBinaryData
                    )
                );
                
                //UpdateContext({
                //    modalExport: true
                //});
                
                Set(Var, true)
            PressedColor: =Color.Transparent
            Text: =
            Visible: =If(currentUser = "DRI", true, false)
            Width: =ExportBtn.Width
            X: =931
            Y: =35
            ZIndex: =23

    ModalExport_Teste_1 As ModalExport_Teste:
        Data: =dataExport
        ModalText: |-
            ="Deseja exportar a listagem completa de Atividades para um ficheiro Excel?
            
            Será efetuado o download após a confirmação."
        Visible: =Var
        X: =50%
        Y: =50%
        ZIndex: =29

    ExportModal As group:
        Height: =5
        Width: =5
        X: =40
        Y: =40
        ZIndex: =32

        ModalExport_1 As ModalExport:
            ExportJSON: =dataExport
            ModalText: |-
                ="Deseja exportar a listagem completa de Atividades para um ficheiro Excel?
                
                Será efetuado o download após a confirmação."
            Visible: =false
            ZIndex: =26

        ExportBtnCode_1 As button:
            BorderColor: =Color.Transparent
            Color: =Color.Transparent
            Fill: =Color.Transparent
            Height: =ExportBtn.Height
            HoverColor: =Color.Transparent
            HoverFill: =Color.Transparent
            OnSelect: |-
                =UpdateContext({
                    modalExport: false
                })
            PressedColor: =Color.Transparent
            Text: =
            Visible: =false
            Width: =41
            X: =858
            Y: =232
            ZIndex: =28

